{% extends 'base.html' %}

{% block title %}Flood Monitoring{% endblock %}

{% block content %}
<h2>Flood Monitoring</h2>

<!-- Dropdown for selecting a station -->
<!-- <select id="stationSelect" onchange="loadReadings()">
    <option value="">Select Station</option>
    {% for station in stations %}
        <option value="{{ station.stationReference }}">{{ station.stationName }}</option>
    {% endfor %}
</select> -->


<select id="stationSelect"> 
    <option value="">Loading...</option>
</select>



<!-- Chart Canvas -->
<canvas id="floodChart" width="400" height="200"></canvas>

<!-- Error Message (If any) -->
<div id="errorMessage" style="color: red; display: none;">
    <p>Sorry, an error occurred while fetching data.</p>
</div>

<!-- Script to Handle Station Data and Chart Rendering -->
<script>

    window.onload = function() {
        getStation();  // Call the function on page load
    };





    // The function to make the API call
    async function getStation() {
            fetch('/monitoring/stations/')
                .then(response => response.json())
                .then(data => {

                    console.log("API Response:", data); 

                    let dropdown = document.getElementById("stationSelect");
                    dropdown.innerHTML = ''; // Clear existing options
                    
                    data.data.items.forEach(item => {

                        console.log(item.stationReference)
                        console.log(item.town)    

                        let option = document.createElement("option");
                        option.value = item.stationReference;
                        option.textContent = item.town;
                        dropdown.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading data:", error));
        



            
            // console.log('in get station browser')
            // const response = await fetch('/monitoring/stations/'); // Adjust this to your API endpoint
            // const data = await response.json();
            // // console.log(data); // Check the response in console

            // $(data.items).each(function(i, item) {
            //     // alert(item);
            //     console.log(item);
            // });

            // let dropdown = document.getElementById("stationSelect");
            //         dropdown.innerHTML = ''; // Clear existing options
                    
            //         data.items.forEach(item => {

            //             console.log(item.stationReference)
            //             console.log(item.town)    

            //             let option = document.createElement("option");
            //             option.value = item.stationReference;
            //             option.textContent = item.town;
            //             dropdown.appendChild(option);
            //         });
    }



    // Function to fetch readings for a selected station
    async function loadReadings() {
        const stationId = document.getElementById('stationSelect').value;
        if (!stationId) return; // If no station is selected, do nothing
        
        try {
            const response = await fetch(`/readings/${stationId}/`); // Fetch readings based on station ID
            const data = await response.json(); // Parse response JSON
            
            if (data.error) {  // If error occurs
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            // Prepare data for chart
            const timestamps = data.map(item => item.timestamp);
            const values = data.map(item => item.value);
            
            // Update chart with new data
            updateChart(timestamps, values);
        } catch (error) {
            document.getElementById('errorMessage').style.display = 'block';  // Show error if fetching fails
            console.error("Error fetching readings:", error);
        }
    }

    // Function to update the chart
    function updateChart(timestamps, values) {
        const ctx = document.getElementById('floodChart').getContext('2d');
        
        // Create chart if it doesn't exist or update if it does
        if (window.myChart) {
            window.myChart.data.labels = timestamps;
            window.myChart.data.datasets[0].data = values;
            window.myChart.update();
        } else {
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Flood Levels',
                        data: values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
    }
</script>
{% endblock %}
